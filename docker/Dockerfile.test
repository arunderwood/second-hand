# Dockerfile for integration testing with chronyd
FROM fedora:41

# Install chrony and curl (for uv installation)
# Python will be managed by uv
RUN dnf install -y \
    chrony \
    curl \
    && dnf clean all

# Create chrony directories with proper permissions for socket
# chrony user needs to own /run/chrony to create the socket
# Add root to chrony group so tests can access the socket
RUN mkdir -p /run/chrony /var/lib/chrony /var/log/chrony \
    && chown chrony:chrony /run/chrony /var/lib/chrony /var/log/chrony \
    && chmod 770 /run/chrony \
    && usermod -aG chrony root

# Copy chrony configuration
COPY docker/chrony.conf /etc/chrony.conf

# Install uv for dependency management (standalone installer)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Set up working directory
WORKDIR /app

# Copy project files
COPY pyproject.toml uv.lock* README.md ./
COPY src/ ./src/
COPY tests/ ./tests/

# Install dependencies using Python 3.14
RUN uv sync --python python3.14 --all-extras --dev

# Set PYTHONPATH and ensure unbuffered output for CI visibility
ENV PYTHONPATH=/app/src
ENV PYTHONUNBUFFERED=1

# Copy and set up the test entrypoint script
COPY docker/run-integration-tests.sh /usr/local/bin/run-integration-tests.sh
RUN chmod +x /usr/local/bin/run-integration-tests.sh

# Default command runs integration tests
CMD ["/usr/local/bin/run-integration-tests.sh"]
